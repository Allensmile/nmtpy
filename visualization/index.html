<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>NMT Visualization Tool</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-1.12.4.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script type='application/javascript'>
      // This contains all the necessary informations for visualization
      var jsonfile = 'sample.json';
      var samples = null;
      var size = null;
      var item = null;

	  /*
      function gen_alignment_matrix() {
		var html = "<table border='1px' align='center' id='attmatrixtable'>";
		html += "<tr id='trglabels'><td>&nbsp;</td>";
		for (var j = 0; j < item.trg.length; ++j) {
			html += "<td>" + item.trg[j] + "</td>";
		}
		html += "</tr>";
		for (var i = 0; i < item.src.length; ++i) {
			html += "<tr align='right' id='amat_src_" + i + "'>";
			html += "<td>" + item.src[i] + "</td>";
			for (var j = 0; j < item.trg.length; ++j) {
				html += "<td id='amat_trg_" + j + "'>&nbsp; &nbsp;</td>";
			}
			html += "</tr>";
		}
		html += "</table>";
		$('#attmatrix').html(html);
      }*/

      function escape(s) {
      	return s.replace('<', '&lt;').replace('>', '&gt;');
	  }

      function render_src_phrase() {
        var src_phrase = "";
        for (var i = 0; i < item.src.length; ++i) {
          src_phrase += "<span class='srcword' id='sw" + i + "'>" + escape(item.src[i]) + "</span>";
        }
        $('#srctext').html(src_phrase);
      }

      function randomize() {
        // Get a random sample from the dataset for further visualization
        var idx = Math.floor(Math.random()*size);
        item = samples[idx];

        var trg_phrase = "";
		render_src_phrase();

        for (var i = 0; i < item.trg.length; ++i) {
          trg_phrase += "<span class='trgword' id='tw" + i + "'>" + escape(item.trg[i]) + "</span>";
        }
        $('#trgtext').html(trg_phrase);

		$('#reftable').html('<thead><tr><th style="width:10px;">#</th><th>Reference</th></tr></thead>');
		// Iterate over references
        for (var i = 0; i < item.ref.length; ++i) {
          var sent = "<tr><td>" + (i+1) + "</td><td>" + escape(item.ref[i]) + "</td></tr>";
          $('#reftable').append(sent);
		}
      }

      // Load JSON
      var jqxhr = $.getJSON(jsonfile, function(data) {
        samples = data.data;
		data.metadata['size'] = samples.length;
		size = samples.length;

        var metadata_html = "<ul>";
        for (var key in data.metadata) {
          metadata_html += "<li><strong>" + key + "</strong>: " + data.metadata[key] + "</li>";
        }
        $('#model_info').html(metadata_html + "</ul>");

		// Append EOS symbols
		for (var i = 0; i < samples.length; ++i) {
		  samples[i].src.push(escape('<eos>'));
		  samples[i].trg.push(escape('<eos>'));
		}
      }).done(function() { randomize(); });

      $(document).on('mouseover', 'div#trgtext', function(e) {
        var target = $(e.target).attr('id');
        if (target.startsWith('tw')) {
          var tw = parseInt(target.replace('tw', ''));
          // We hovered over target word tw
          for (var i = 0; i < item.att[tw].length; ++i) {
            $('#sw' + i).animate({'opacity': item.att[tw][i]}, 10);
          }
        }
      });

	  // Call randomize() on click
      $(document).on('click', '#randombutton', function () {
        randomize();
      });

      // Revert back to full opacities once we leave the target sentence box
      $(document).on('mouseleave', 'div#trgtext', function(e) {
        $('#srctext').children().each(function() {
          $(this).animate({'opacity' : 1}, 20);
        });
      });

    </script>

  </head>
  <body>
    <div class="page-header text-center">
  <h1>NMT Attention Visualization <small>for nmtpy</small></h1>
    </div>
    <div class="container" style="width:75%">
	<h3>Model Details</h3>
	<div class="row text-left" id="model_info">
	</div>
    </div>
    <div class="container" id="vis" style="width:75%">
      <div class="row text-right">
		<div class="btn-group" role="group">
			<button type="button" class="btn btn-primary" aria-label="Randomize" id="randombutton">Randomize</button>
        </div>
      </div>
      <div class="row text-center attention" id="attmatrix">
      </div>
      <div class="row text-center source">
        <div class="col-md-2 text-right"><h3>Source</h3></div>
        <div class="sentence col-md-10" id="srctext"></div>
      </div>
      <div class="row text-center target">
        <div class="col-md-2 text-right"><h3>Hypothesis</h3></div>
        <div class="sentence col-md-10" id="trgtext"></div>
      </div>
      <div class="row reference">
        <div class="col-md-2 text-right"><h3>References</h3></div>
        <div class="col-md-10" id="reftext">
          <table class="table table-striped" id="reftable">
          </table>
      </div>
    </div>

  </body>
</html>
